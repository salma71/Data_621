---
title: "Data 621 - Homework 3"
author: "Dhairav Chhatbar, Mael Illien, Salma Elshahawy"
date: "10/15/2020"
output: 
  html_document:
    code_folding: hide
    theme: cosmo
    highlight: tango
    toc: true
    number_section: false
    toc_float:
      collapsed: true
      smooth_scroll: true
    df_print: paged
---
# Data 621 Homework3 

## Introduction 


```{r message=FALSE, warning=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment=NA, message=FALSE, warning=FALSE)
library(skimr)
library(ggplot2)
library(ggcorrplot)
library(tidyverse)
library(PerformanceAnalytics)
library(DMwR)
library(caret)
library(kableExtra)
library(DescTools)
library(cowplot)
library(pROC)
```

```{r message=FALSE, warning=FALSE}
data_train <- read.csv("https://raw.githubusercontent.com/salma71/Data_621/master/HW_3/crime-training-data_modified.csv", header = TRUE)
data_test <- read.csv("https://raw.githubusercontent.com/salma71/Data_621/master/HW_3/crime-evaluation-data_modified.csv", header = TRUE)
```

## Data Exploration {.tabset .tabset-fade .tabset-pills}

### Data Exploration

```{r data_summary_train, message=FALSE, warning=FALSE}
skim(data_train)
```

---

### Missing Data

There is no missing data per the skim summary above.

```{r explore_missing_data_train, message=FALSE, warning=FALSE}
# data_train %>%
#   gather(variable, value) %>%
#   filter(is.na(value)) %>%
#   group_by(variable) %>%
#   tally() %>%
#   mutate(percent = n / nrow(data_train) * 100) %>%
#   mutate(percent = paste0(round(percent, ifelse(percent < 10, 1, 0)), "%")) %>%
#   arrange(desc(n)) %>%
#   rename(`Variable Missing Data` = variable,
#          `Number of Records` = n,
#          `Share of Total` = percent) %>%
#   kable() %>%
#   kable_styling()
```

---

### Visualization

```{r variables_distribution, fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
data_train %>% 
  select(-target) %>%
  gather() %>% 
  ggplot(aes(x= value)) + 
  geom_density(fill='pink') + 
  facet_wrap(~key, scales = 'free')
```

#### Correlations with Response Variable

```{r correlations_plot, fig.height=8, fig.width=10, message=FALSE, warning=FALSE}
q <- cor(data_train)
ggcorrplot(q, type = "upper", outline.color = "white",
           ggtheme = theme_classic,
           colors = c("#6D9EC1", "white", "#E46726"),
           lab = TRUE, show.legend = FALSE, tl.cex = 8, lab_size = 3) 
```

```{r}
#pairs(data_train, col=data_train$target)
```


---

## Data Preparation {.tabset .tabset-fade .tabset-pills}



---

### Data Transformation 



---
 
### Feature Engineering 


---

## Model Building {.tabset .tabset-fade .tabset-pills}

```{r}
models.df <- tibble(id=character(), formula=character(), res.deviance=numeric(), null.deviance=numeric(),
                 aic=numeric(), accuracy=numeric(), sensitivity=numeric(), specificity=numeric(),
                precision.deviance=numeric(), stringsAsFactors=FALSE) 
```


```{r}
build_model <- function(id, formula, data) {
  glm.fit <- glm(formula, data=data, family=binomial)
  print(summary(glm.fit))
  glm.probs <- predict(glm.fit, type="response")
  # Confirm the 0.5 threshold
  glm.pred <- ifelse(glm.probs > 0.5, 1, 0)
  results <- tibble(target=data_train$target, pred=glm.pred)
  results <- results %>%
    mutate(pred.class = as.factor(pred), target.class = as.factor(target))
  
  #print(confusionMatrix(results$pred.class,results$target.class, positive = "1"))
  
  acc <- confusionMatrix(results$pred.class,results$target.class, positive = "1")$overall['Accuracy']
  sens <- confusionMatrix(results$pred.class,results$target.class, positive = "1")$byClass['Sensitivity']
  spec <- confusionMatrix(results$pred.class,results$target.class, positive = "1")$byClass['Specificity']
  prec <- confusionMatrix(results$pred.class,results$target.class, positive = "1")$byClass['Precision']
  res.deviance <- glm.fit$deviance
  null.deviance <- glm.fit$null.deviance  
  aic <- glm.fit$aic
  metrics <- list(res.deviance=res.deviance, null.deviance=null.deviance,aic=aic, accuracy=acc, sensitivity=sens, specificity=spec, precision=prec)
  metrics <- lapply(metrics, round, 3)
  
  plot(roc(results$target.class,glm.probs), print.auc = TRUE)
  model.df <- tibble(id=id, formula=formula, res.deviance=metrics$res.deviance, null.deviance=metrics$null.deviance, 
                         aic=metrics$aic, accuracy=metrics$accuracy, sensitivity=metrics$sensitivity, specificity=metrics$specificity, precision=metrics$precision)
  model.list <- list(model=glm.fit, df_info=model.df)
  #print(model.df)
  
  #models.df <- rbind(models.df,model.df)
  return(model.list)
}
```

### Model_1.1 

```{r}
# glm.fit1 <- glm(target ~ ., data=data_train, family=binomial)
# summary(glm.fit1)
m1 <- build_model('m1', "target ~ .", data = data_train)
m1$df_info
models.df <- rbind(models.df,m1$df_info)
```

```{r}
# glm.fit2 <- glm(target ~ . -rm, data=data_train, family=binomial)
# summary(glm.fit2)

m2 <- build_model('m2', "target ~ . -rm", data = data_train)
m2$df_info
models.df <- rbind(models.df,m2$df_info)
```
```{r}
# glm.fit3 <- glm(target ~ . -rm -chas, data=data_train, family=binomial)
# summary(glm.fit3)
m3 <- build_model('m3', "target ~ . -rm", data = data_train)
m3$df_info
models.df <- rbind(models.df,m3$df_info)
```

```{r}
# glm.fit4 <- glm(target ~ . -rm -chas -indus, data=data_train, family=binomial)
# summary(glm.fit4)
m4 <- build_model('m4', "target ~ . -rm -chas -indus", data = data_train)
m4$df_info
models.df <- rbind(models.df,m4$df_info)
```

```{r}
# glm.fit5 <- glm(target ~ . -rm -chas -indus -lstat, data=data_train, family=binomial)
# summary(glm.fit5)
m5 <- build_model('m5', "target ~ . -rm -chas -indus -lstat", data = data_train)
m5$df_info
models.df <- rbind(models.df,m5$df_info)
```

```{r}
models.df
```


### Model_1.2 

### Model_1.3 

Transforming the predictors with significant skew and adding them to the base model.

```{r}
trans_models.df <- tibble(id=character(), formula=character(), res.deviance=numeric(), null.deviance=numeric(),
                 aic=numeric(), accuracy=numeric(), sensitivity=numeric(), specificity=numeric(),
                precision.deviance=numeric(), stringsAsFactors=FALSE) 
```

```{r warning=FALSE}
mt1 <- build_model("mt1" ,"target ~ . + log(dis)+log(nox)", data=data_train)
mt1$df_info
trans_models.df  <- rbind(trans_models.df, mt1$df_info)
```


```{r}
#glm.fit32 <- glm(target ~ nox + tax, data=data_train, family=binomial)
#summary(glm.fit32)
mt2 <- build_model("mt2","target ~ . + log(dis)+log(nox)-indus", data=data_train)
mt2$df_info
trans_models.df  <- rbind(trans_models.df, mt2$df_info)
```


```{r}
# glm.fit33 <- glm(target ~ nox + log(nox) + tax, data=data_train, family=binomial)
# summary(glm.fit33)
mt3 <- build_model("mt3","target ~ . + log(dis)+log(nox)-indus-chas", data=data_train)
mt3$df_info
trans_models.df  <- rbind(trans_models.df, mt3$df_info)
```

```{r}
# glm.fit34 <- glm(target ~ nox + log(nox) + indus + zn + age + tax, data=data_train, family=binomial)
# summary(glm.fit34)
mt4 <- build_model("mt4","target ~ . + log(dis)+log(nox)-indus-chas-rm", data=data_train)
mt4$df_info
trans_models.df  <- rbind(trans_models.df, mt4$df_info)
```



```{r}
# glm.fit5 <- glm(target ~ . -rm -chas -indus -lstat, data=data_train, family=binomial)
# summary(glm.fit5)
mt5 <- build_model("mt5","target ~ . + log(dis)+log(nox)-indus-chas-rm-lstat", data=data_train)
mt5$df_info
trans_models.df  <- rbind(trans_models.df, mt5$df_info)
```


## Model Selection 

```{r}
models.df
```

```{r}
trans_models.df
```
---
